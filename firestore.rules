rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // =============================================
    // Helper Functions
    // =============================================
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Validate string length
    function isValidString(str, minLen, maxLen) {
      return str is string && str.size() >= minLen && str.size() <= maxLen;
    }

    // =============================================
    // Blog Posts
    // =============================================
    match /posts/{postId} {
      // Read: Anyone can read published posts, admins can read all
      allow get: if resource.data.published == true || isAdmin();
      allow list: if isAdmin() ||
        (request.query.limit <= 50 &&
         ('published' in request.query) == false || request.query.published == true);

      // Write: Only admins
      allow create: if isAdmin() && validatePost();
      allow delete: if isAdmin();

      // Update: Admins full access, signed-in users can only increment views/likes
      allow update: if isAdmin() ||
        (isSignedIn() &&
         resource.data.published == true &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views', 'likes']) &&
         // Ensure views/likes can only increase by 1
         (request.resource.data.views == resource.data.views + 1 ||
          request.resource.data.likes == resource.data.likes + 1));

      function validatePost() {
        let data = request.resource.data;
        return isValidString(data.title, 1, 200) &&
               isValidString(data.slug, 1, 200) &&
               isValidString(data.content, 1, 100000) &&
               isValidString(data.excerpt, 1, 500) &&
               data.tags is list && data.tags.size() <= 10;
      }
    }

    // =============================================
    // Tutorials
    // =============================================
    match /tutorials/{tutorialId} {
      // Read: Anyone can read published tutorials, admins can read all
      allow get: if resource.data.published == true || isAdmin();
      allow list: if isAdmin() ||
        (request.query.limit <= 50 &&
         ('published' in request.query) == false || request.query.published == true);

      // Write: Only admins
      allow create: if isAdmin() && validateTutorial();
      allow delete: if isAdmin();

      // Update: Admins full access, signed-in users can only increment views/likes
      allow update: if isAdmin() ||
        (isSignedIn() &&
         resource.data.published == true &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views', 'likes']) &&
         (request.resource.data.views == resource.data.views + 1 ||
          request.resource.data.likes == resource.data.likes + 1));

      function validateTutorial() {
        let data = request.resource.data;
        return isValidString(data.title, 1, 200) &&
               isValidString(data.slug, 1, 200) &&
               isValidString(data.content, 1, 100000) &&
               data.difficulty in ['beginner', 'intermediate', 'advanced'];
      }
    }

    // =============================================
    // Categories
    // =============================================
    match /categories/{categoryId} {
      allow read: if true;
      allow create: if isAdmin() && validateCategory();
      allow update: if isAdmin();
      allow delete: if isAdmin();

      function validateCategory() {
        let data = request.resource.data;
        return isValidString(data.name, 1, 50) &&
               isValidString(data.slug, 1, 50) &&
               data.slug.matches('^[a-z0-9-]+$');
      }
    }

    // =============================================
    // Tags
    // =============================================
    match /tags/{tagId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // =============================================
    // Comments
    // =============================================
    match /comments/{commentId} {
      // Read: Admins see all, public only sees approved
      allow get: if isAdmin() || resource.data.approved == true;
      allow list: if isAdmin() ||
        (request.query.limit <= 100 &&
         ('approved' in request.query) == false || request.query.approved == true);

      // Create: Signed-in users with validation
      allow create: if isSignedIn() && validateComment();

      // Update: Owner can edit content (before approval), admin can moderate
      allow update: if isAdmin() ||
        (isOwner(resource.data.userId) &&
         resource.data.approved == false &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['content']));

      // Delete: Owner or admin
      allow delete: if isOwner(resource.data.userId) || isAdmin();

      function validateComment() {
        let data = request.resource.data;
        return isValidString(data.content, 1, 1000) &&
               data.userId == request.auth.uid &&
               isValidString(data.postId, 1, 100) &&
               data.approved == false; // New comments must start as unapproved
      }
    }

    // =============================================
    // Admin Users (Read-only from client)
    // =============================================
    match /admins/{userId} {
      // Only signed-in users can check admin status
      allow read: if isSignedIn();
      // Admin list can only be modified via Firebase Console or Admin SDK
      allow write: if false;
    }

    // =============================================
    // User Profiles
    // =============================================
    match /users/{userId} {
      allow read: if true;
      allow create: if isOwner(userId) && validateUserProfile();
      allow update: if isOwner(userId) && validateUserProfile();
      allow delete: if isAdmin();

      function validateUserProfile() {
        let data = request.resource.data;
        return isValidString(data.displayName, 1, 100) &&
               (!('bio' in data) || isValidString(data.bio, 0, 500));
      }
    }

    // =============================================
    // Analytics (Rate limited via application)
    // =============================================
    match /analytics/{docId} {
      allow read: if isAdmin();
      // Only allow creating analytics from signed-in users to prevent spam
      allow create: if isSignedIn() && validateAnalytics();
      allow update, delete: if isAdmin();

      function validateAnalytics() {
        let data = request.resource.data;
        return data.event in ['view', 'like', 'comment', 'share', 'login', 'signup'] &&
               data.userId == request.auth.uid;
      }
    }

    // =============================================
    // User Activity Tracking
    // =============================================
    match /userActivity/{userId} {
      // Admins can read all user activity
      allow read: if isAdmin();
      // Users can read their own activity
      allow get: if isOwner(userId);
      // Users can create/update their own activity record
      allow create, update: if isOwner(userId) && validateUserActivity();
      allow delete: if isAdmin();

      function validateUserActivity() {
        let data = request.resource.data;
        return data.userId == request.auth.uid;
      }
    }

    // =============================================
    // Site Settings
    // =============================================
    match /settings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // =============================================
    // Security: Deny all other paths
    // =============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
